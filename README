Weather station using moteino

Weather(1) was a pic, communcating on homenet. It managed a tipping bucket rain gauge and a temperature sensor.  16f84 or 16f628?  As at 2018, the HW was 16f628 with a Dallas DS1620 for temperature. In projects/older/rain. Looks to date from 2007. In assembler.
It ran up in nowendoc for a year or two... but I regularly destroyed rs485 drivers on the CC connection for Homenet.  After about the 5th was replaced.. I found the weather1 board was intermittent.  Worked sometimes, and I'm not sure I still have a PIC programmer or desire to keep fixing the wired network. A lightning strike in Jan 2018 on the oak tree convinced me wired sensor networks was a bad idea.   

Weather2 was started in Dec 2017 as a replacement for weather1.  Its teensy 2.0 based, an ATMEGA32U4 8 bit AVR 16 MHz, and written in c. It seems to be a 5v part.  Its got a USBHID interface.
It features interfaces to
Davis tipping bucket rain gauge
Davis wind vane (wind speed and direction)
BMP280 Bosch temperature and pressure sensor
SHT31-D temperature and humidity sensor
pretty much all my own code.  Interrupts are used for wind speed and rain bucket, with a timer used to debounce the rain int.
What weather2 lacks is a decent comms interface....

So I can either port the weather2 code to a moteino, or use a moteino as a radio for the teensy. The teensy is USBHID rather than 2 wire serial so the radio is slightly less attractive. Except I seem to have an esp8266 already connected..

Getting low power for the gadget is a bit attractive.. how does that gel with interrupt response?
Or at least low enough power to be solar powered.

The teensy draws 20mA at 12v. Has an inline switcher to 3.6V.
The serial lines to the esp8266 .. hmm, arnt any. It was just running of fthe 3v3.   Current is down to 13mA without the esp8266. (from 12V).
9ma  just into the switchmode reg, so its idling at 100mw.
Setting the psu to 3v3 and running the teensy directly.. 12.6mA @ 3v3

The moteino apparently will do 8ma idling, and much better in low power sleep if I can make it wake on pin change interrupt.

So my options could be ~20mA @ 3v3 for motino + teensy, vs lets be optimistic and say 1mA for the
teensy only.

A 6V solar panel I got for these produces 7V and 50mA pointing at the sun behind some cloud (can see where the sun is, not heavy cloud) on a gray winters day in light showers. Thats not going to run 20ma 24 hours a day. Should run 1mA happily. So worth trying to port off teensy too straight moteino.

Seems I need to run in sleep mode most of the time.
So either need some HW assistance to notice input transitions and store them till the moteino aways from a short sleep, or have the interrupt wake it directly.

https://lowpowerlab.com/forum/low-power-techniques/wake-moteino-mega-using-pin-change-interrupt/
suggests external interrupts should work.

Lets do an IO count..
I have
2 x I2C things. (SHT31-D temperature and humidity sensor and
  BMP280 Bosch temperature and pressure sensor

1 x int Davis tipping bucket rain gauge
1 x int, 1 x analog.     Davis wind vane (wind speed and direction)

so pin count isn't bad.
Could probably debounce the tipping bucket with a little foreground assistance too. 

seems ..
I2c scl likes to be on D0
I2C sda likes to be on PD1
radio is on D2, D11,12,13
pins 2 + 3 are interrupts. Radio uses one of these.
pin change interrupts are probably supported in sleep mode. 


UPDATE Oct 2021
Some time in Feb 2019 I split the weatherino stuff into 2 parts.
A thing called weatherino, up high, running the rain and wind gauges.
Its currently got  4.5AH 12V Lead acid gel cell, and a ~5W solar cell on the north facing slopey roof. And a switching reg to 3.3v

A thing called weatherino_temperature, down low, in a stephensen screen, doing temperature and pressure and humidity.
Its got a tiny 1W 6V solar cell, and an 18650 battery with a little linear charge controller.  The solar cell is unencapsulated, mounted on the east side of the solar screen, glued on  the vertical wall.   

Split due to the lightning damage I have had. Don't want long wires.

Over the last 2.5 years, the weatherino_temperature has been very reliable. I guess this is because its usually asleep, waking each 8 minutes to send temperature/humididity/pressure. I suspect its the lower power radio, CW.

Over the last 2.5 years, the weatherino has NOT been very reliable. Regular battery flat issues.  I guess this is because its not usually asleep, always awake waiting for wind or temp interrupts.  Coupled with a few overcast days or a wet week or the like, it all stops.

I need to
* measure the actual run current as is
* measure the standby current of the battery charger and the switcher.
* see if I can put the thing into light sleep, so that pin change and internal timers both wake the cpu, and get a current point on that.
* decide which way to go based on the above.

Lets get some actual numbers!.

put code into a spare moteino with a rfm69CW, reprogrammed to
 # change address to 0x23
 # change inputs on 6,7 to input_pullup
 # attach pushbuttons to D6, D7

* 26.8mA at 4.4v on psu with LDO onboard.
* 9.8mA at 4.4v on psu with LDO onboard, after adding radio.sleep() after a transmission. since receiver is 16mA, makes sense..
  That was an easy 16ma to gain!


# add an idle call, 15ms. 
* 4.4mA.   but is it working? I have DEBUG on, so should tx every 16s. All seems good. The trick is to keep timer0 running as it makes millis()_

# should ensure all other IOs are driven to 0.



# now check a switcher. it idles at 9.9mA from 13.2V.
# at 50mA load, 23.9mA   vo=3.64
# at 100mA  Iin=37.88mA, Vin=13.2 Vo=3.63
# at 1000mA Iin=310mA   Vin=13.2 Vo=3.57   (will be some loss in the current meter reducing efficiency a tad)

# the led on the board is red with 1K in series. assuming 1.6v, thats just under 2mA from the output.
# so the switcher draws 130mW just idling from ~12V.  Thats my biggest single power consumption,
#    and its off the battery, so always present, not off the solar.

# finally, what does the solar reg draw with no solar there?
# 12.2mA

# so today I have 12.2 + 9.9 ma of supply losses, plus 26.8mA at 3V3 (7.3mA) for a total of 30mA at 12V
# a good 4.5AH battery can run that 153 hours or 6.4 days
# I suspect my battery might be at 30 % as it worked for 24 hrs from mid charge.

# now, if I can get current to 4mA, then a single 18650 3AH seems a better all round solution.
# Do I still have the 6V solar cell up there? And a TP4056  reg?   YES and YES
# else .. whats involved in switching 12V solar to ~4.5 V?   Do I need MPPT, or just to not get stuck?
# I'd be a tad worried with a standard switcher, likely to get stuck in constant current low voltage state I suspect.
# While the TP4056 manages charge, it doesn't protect. possibly want a DW01A or similar to do undervoltage cutout.
# Do the test boards I have do that? NO.

# so buy a couple of  MPPT modules + some 4056+protection modules.
The MPPT were $US13 for 2, the 4056 $8 for 5.   MPPT rated 12..28V in. adjustable. 4056 rated 4.5 .. . 5.5 in.

MPPT out of china so will be a few weeks, fit when they get here.